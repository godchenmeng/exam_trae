# 技术方案与系统设计评审（地图绘制题）

本评审记录用于固化“地图绘制题”在现有 WPF 客户端中的技术路线、数据结构与实现边界，指导迭代开发与验收。


一、总体技术路线
- 客户端框架：WPF（.NET）
- 地图承载：WebView2（Chromium 内核），加载本地 Assets/Map 下的 HTML/JS 页面
- 地图引擎：百度地图 Web JS SDK（离线使用本地资源，页面与脚本本地化；若需在线地图瓦片，需在考试机具网络策略内允许访问，默认按离线优先）
- JS-.NET桥接：
  - 初始化：WebView2 CoreWebView2 初始化完成后注入 HostObject（例如 window.chrome.webview.hostObjects.examBridge）或使用 postMessage 通道
  - 消息方向：
    1) .NET -> JS：加载题目数据（配置、辅助指引图层、参考答案图层；学生端不传参考答案）、允许的工具与约束、图标库与城市坐标资源
    2) JS -> .NET：学生作答覆盖物（Overlays JSON）、作答事件（开始/结束/撤销/重做）、截图请求（可选）、错误报告
  - 消息格式：JSON，统一字段命名（camelCase），且包含 messageType、payload 两层
- 数据持久化：SQLite，本地双副本（项目根 exam_system.db、WPF/ exam_system.db），通过迁移脚本保持结构一致
- 评分机制：仅人工评分（教师阅卷页面），保存主观分数与评语
- 安全与权限：
  - 教师端：可查看/编辑参考答案图层、辅助指引图层
  - 学生端：仅显示辅助指引图层，无法查看参考答案图层；约束工具集与图层类型
- 日志：本地文件 Logs/，记录桥接消息与错误；支持草稿保存


二、数据结构（核心 JSON Schema 摘要）
- OverlayDTO（统一覆盖物结构）：
  - common: id(string), type(enum: marker|polyline|polygon|rect|circle), editable(bool), visible(bool)
  - geometry:
    - marker: { lng, lat }
    - polyline: { path: [{ lng, lat }, ...] }
    - polygon: { path: [{ lng, lat }, ...] }
    - rect: { sw: {lng,lat}, ne: {lng,lat} }
    - circle: { center:{lng,lat}, radius:number }
  - style: { strokeColor, strokeWeight, strokeOpacity, fillColor, fillOpacity, iconKey?, dashArray?, lineTexture? }
  - meta: { label?, note?, category? }
- MapDrawingConfig：
  - allowedTools: ["marker","polyline","polygon","rect","circle"]
  - requiredOverlays: [{ type, min?, max? }]（例如必须画1条折线，最多3个点）
  - constraints: { maxOverlayCount?, maxVerticesPerShape?, snapToRoad?:bool, snapTolerance?:number }
  - showBuildingLayers: { cityCode:string, enabled:bool, layers:["residential","commercial", ...] }
  - timeLimitSeconds?: number
- GuidanceOverlays：OverlayDTO[]（辅助指引图层，仅学生端可见、不可编辑）
- ReferenceOverlays：OverlayDTO[]（参考答案图层，仅教师端可见，在阅卷对比使用）
- ReviewRubric：{ total: number, items:[ { key, name, maxScore, description } ] }（人工评分量表）
- AnswerOverlays：OverlayDTO[]（学生最终作答覆盖物，随 AnswerRecord.UserAnswer 保存）


三、桥接协议消息示例（v0.1）
- .NET -> JS：加载题目
{
  "messageType": "LoadQuestion",
  "payload": {
    "questionId": 123,
    "config": { "allowedTools":["polyline"], "requiredOverlays":[{"type":"polyline","min":1,"max":1}] },
    "guidanceOverlays": [ {"id":"g1","type":"marker","geometry":{"lng":116.404,"lat":39.915},"style":{}} ],
    "referenceOverlays": [] // 学生端为空
  }
}
- JS -> .NET：提交答案
{
  "messageType": "SubmitAnswer",
  "payload": {
    "questionId": 123,
    "overlays": [ {"id":"s1","type":"polyline","geometry":{"path":[{"lng":116.4,"lat":39.9},{"lng":116.41,"lat":39.91}]} } ],
    "drawDurationSeconds": 278
  }
}
- JS -> .NET：错误报告
{
  "messageType": "Error",
  "payload": { "code": "MapInitFailed", "detail": "BMap not found" }
}


四、数据库字段扩展（SQLite）
- Questions（新增列，均允许 NULL，除非特别说明）：
  - MapDrawingConfigJson TEXT
  - GuidanceOverlaysJson TEXT
  - ReferenceOverlaysJson TEXT
  - ReviewRubricJson TEXT
  - TimeLimitSeconds INTEGER DEFAULT 0
  - ShowBuildingLayersJson TEXT
  - 说明：当 QuestionType = MapDrawing（新枚举值）时，上述字段参与读写；其他题型忽略
- AnswerRecords（新增列）：
  - DrawDurationSeconds INTEGER DEFAULT 0
  - ClientInfoJson TEXT
  - RubricScoresJson TEXT
  - 说明：
    - UserAnswer 字段存放 AnswerOverlays JSON（统一结构）
    - Score/IsGraded/Comment/GradeTime/GraderId 用于人工阅卷记录


五、WPF 视图与页面
- 教师出题（Views/MapDrawingAuthoring.xaml + VM）：配置题干、工具约束、辅助指引图层编辑、参考答案图层编辑、评分量表；保存到 Questions 表
- 学生作答（Views/MapDrawingAnswering.xaml + VM）：加载题目配置与辅助指引，提供绘图工具，提交答案（AnswerRecords.UserAnswer + DrawDurationSeconds）
- 教师阅卷（Views/MapDrawingReview.xaml + VM）：加载参考答案图层与学生答案，支持对比查看（叠加/透明度/图层开关），录入分数与评语，保存评分（Score/IsGraded/Comment/GradeTime/GraderId + RubricScoresJson）
- WebView2 地图页面（Assets/Map/index.html + scripts/*.js）：
  - 工具：选择/拖拽、点、线、面、矩形、圆、删除、撤销/重做
  - 显示：辅助指引图层固定不可编辑；学生端不显示参考答案图层
  - 序列化：Overlays JSON 与 .NET 模型字段一致（坐标顺序、命名约定）


六、日志与错误处理（本地）
- WebView2 初始化失败：提示重试/降级；写 Logs/webview-init.log
- 地图未加载或 JS 错误：捕获并上报 Error 消息；写 Logs/map-error.log
- 数据读写异常：保存草稿到 Temp/ 下的 JSON 文件；提示用户稍后重试


七、性能与兼容
- 批量消息：提交答案与加载图层采用批量 JSON（控制对象数量、避免频繁桥接）
- 抽稀策略：折线点过多时进行抽稀（Douglas-Peucker 可选），在 JS 端执行
- 低端机器优化：限制最大覆盖物数量、降级纹理效果；桥接消息分块传输


八、验收边界
- 仅人工评分，不做自动判分
- 学生端不可查看参考答案图层
- 题目数据与答案数据均采用本地 SQLite 存储，且双副本结构一致（root 与 WPF）
- 通过示例题目端到端走通：出题 -> 作答 -> 阅卷 -> 保存评分


九、迭代建议
- 迭代1：数据库结构扩展、桥接协议最小集（加载/提交）、学生作答页面 MVP
- 迭代2：教师出题与阅卷页面、评分量表、日志与草稿保存
- 迭代3：资源完善（城市坐标、图标库、纹理）、性能优化与冒烟测试