# åœ°å›¾æ•°æ®å®Œæ•´æ€§ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼š`mapData` åªåŒ…å«äº†ç»˜åˆ¶å›¾æ¡ˆçš„ä¿¡æ¯ï¼Œæ²¡æœ‰åŒ…å«åœ°å›¾çš„ `center` å’Œ `zoom` ä¿¡æ¯ã€‚åŸå§‹æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š
```json
{
  "data": "{\"center\":{\"lng\":106.62999999999998,\"lat\":26.64999997900177},\"zoom\":12,\"overlays\":[{\"id\":\"ov-1\",\"type\":\"marker\",\"name\":\"å‰§æ¯’å“ 1\",\"point\":{\"lng\":106.61821423171293,\"lat\":26.61382968456443}},{\"id\":\"ov-2\",\"type\":\"marker\",\"name\":\"æœ‰æ¯’å“ è¿œç¦»é£Ÿå“ 2\",\"point\":{\"lng\":106.75216954931659,\"lat\":26.64999995800354}}]}"
}
```

ä½†åœ¨ä¿å­˜åˆ°æ•°æ®åº“æ—¶ï¼Œåªä¿å­˜äº† `overlays` éƒ¨åˆ†ï¼Œä¸¢å¤±äº† `center` å’Œ `zoom` ä¿¡æ¯ã€‚

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“ç»“æ„åˆ†æ âœ…
ç¡®è®¤ `AnswerRecord` å®ä½“å·²åŒ…å«å®Œæ•´çš„åœ°å›¾æ•°æ®å­—æ®µï¼š
- `MapDrawingData` (TEXT): å­˜å‚¨å®Œæ•´çš„åœ°å›¾ç»˜åˆ¶æ•°æ®JSON
- `MapCenter` (TEXT): å­˜å‚¨åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡JSON
- `MapZoom` (INTEGER): å­˜å‚¨åœ°å›¾ç¼©æ”¾çº§åˆ«

### 2. ä¿®æ”¹æ•°æ®ç”Ÿæˆé€»è¾‘ âœ…
**æ–‡ä»¶**: `ExamSystem.WPF/ViewModels/FullScreenExamViewModel.cs`
**ä½ç½®**: ç¬¬ 131-156 è¡Œ

**ä¿®æ”¹å‰**:
```csharp
// è§£æå†…å±‚JSONæ•°æ®ï¼Œæå–overlayså¹¶è½¬æ¢æ ¼å¼
var innerJsonDoc = System.Text.Json.JsonDocument.Parse(innerDataString);
var hasOverlays = innerJsonDoc.RootElement.TryGetProperty("overlays", out var overlaysElement);

// è½¬æ¢å‰ç«¯overlaysæ•°æ®æ ¼å¼ä¸ºåç«¯MapDrawingDtoæ ¼å¼
var convertedOverlays = hasOverlays ? ConvertOverlaysToMapDrawingData(overlaysElement) : new List<MapDrawingDto>();
mapData = System.Text.Json.JsonSerializer.Serialize(convertedOverlays);
```

**ä¿®æ”¹å**:
```csharp
// è§£æå†…å±‚JSONæ•°æ®ï¼Œæå–å®Œæ•´çš„åœ°å›¾ä¿¡æ¯
var innerJsonDoc = System.Text.Json.JsonDocument.Parse(innerDataString);
var hasOverlays = innerJsonDoc.RootElement.TryGetProperty("overlays", out var overlaysElement);
var hasCenter = innerJsonDoc.RootElement.TryGetProperty("center", out var centerElement);
var hasZoom = innerJsonDoc.RootElement.TryGetProperty("zoom", out var zoomElement);

// æ„å»ºåŒ…å«å®Œæ•´ä¿¡æ¯çš„åœ°å›¾æ•°æ®å¯¹è±¡
var completeMapData = new Dictionary<string, object>();

// è½¬æ¢å‰ç«¯overlaysæ•°æ®æ ¼å¼ä¸ºåç«¯MapDrawingDtoæ ¼å¼
var convertedOverlays = hasOverlays ? ConvertOverlaysToMapDrawingData(overlaysElement) : new List<MapDrawingDto>();
completeMapData["overlays"] = convertedOverlays;

// ä¿ç•™centerå’Œzoomä¿¡æ¯
if (hasCenter)
{
    completeMapData["center"] = System.Text.Json.JsonSerializer.Deserialize<object>(centerElement.GetRawText());
}
if (hasZoom)
{
    completeMapData["zoom"] = zoomElement.GetInt32();
}

mapData = System.Text.Json.JsonSerializer.Serialize(completeMapData);
```

### 3. éªŒè¯æ•°æ®è¯»å–é€»è¾‘ âœ…
**æ–‡ä»¶**: `ExamSystem.WPF/Dialogs/GradeAnswerDialog.xaml.cs`

ç¡®è®¤ä»¥ä¸‹ç»„ä»¶æ­£ç¡®å¤„ç†å®Œæ•´çš„åœ°å›¾æ•°æ®ï¼š

1. **SubjectiveAnswerItem ç±»** (ç¬¬ 708-711 è¡Œ):
   ```csharp
   public string? MapCenter { get; set; }
   public int? MapZoom { get; set; }
   public string? MapDrawingData { get; set; }
   ```

2. **æ•°æ®åŠ è½½é€»è¾‘** (ç¬¬ 509-511 è¡Œ):
   ```csharp
   // åœ°å›¾ç»˜åˆ¶é¢˜æ•°æ®
   MapCenter = ar.MapCenter,
   MapZoom = ar.MapZoom,
   MapDrawingData = ar.MapDrawingData
   ```

3. **åœ°å›¾URLæ„å»º** (ç¬¬ 668-670 è¡Œ):
   ```csharp
   var encodedMapData = Uri.EscapeDataString(mapQuestion.MapDrawingData);
   var encodedMapCenter = Uri.EscapeDataString(mapQuestion.MapCenter ?? "116.404,39.915");
   var mapZoom = mapQuestion.MapZoom ?? 10;
   
   MapViewerUrl = $"http://localhost:{_serverPort}/index.html?mode=review&mapData={encodedMapData}&center={encodedMapCenter}&zoom={mapZoom}";
   ```

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. æ•°æ®å®Œæ•´æ€§ä¿éšœ
- ä¿ç•™åŸå§‹åœ°å›¾çš„ `center` å’Œ `zoom` ä¿¡æ¯
- è½¬æ¢ `overlays` æ•°æ®ä¸ºåç«¯å…¼å®¹æ ¼å¼
- æ„å»ºåŒ…å«å®Œæ•´ä¿¡æ¯çš„åœ°å›¾æ•°æ®å¯¹è±¡

### 2. å‘åå…¼å®¹æ€§
- ä¿æŒç°æœ‰çš„ `MapDrawingDto` è½¬æ¢é€»è¾‘
- ä¸å½±å“ç°æœ‰çš„åœ°å›¾ç»˜åˆ¶åŠŸèƒ½
- å…¼å®¹å·²æœ‰çš„æ•°æ®åº“ç»“æ„

### 3. é”™è¯¯å¤„ç†
- æ·»åŠ äº†å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- æä¾›é»˜è®¤å€¼é˜²æ­¢æ•°æ®ç¼ºå¤±
- è°ƒè¯•æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
å‰ç«¯åœ°å›¾æ•°æ® (WebView2)
    â†“
åŸå§‹JSON: {"center": {...}, "zoom": 12, "overlays": [...]}
    â†“
FullScreenExamViewModel.CollectAllMapDrawingDataAsync()
    â†“
è§£æå¹¶æ„å»ºå®Œæ•´æ•°æ®å¯¹è±¡:
{
  "overlays": [è½¬æ¢åçš„MapDrawingDtoæ•°ç»„],
  "center": {"lng": 106.63, "lat": 26.65},
  "zoom": 12
}
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ AnswerRecord:
- MapDrawingData: å®Œæ•´JSONæ•°æ®
- MapCenter: centeréƒ¨åˆ†çš„JSON
- MapZoom: zoomæ•°å€¼
    â†“
GradeAnswerDialog è¯»å–å¹¶æ˜¾ç¤º
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
1. å¯åŠ¨ WPF åº”ç”¨ç¨‹åº
2. åˆ›å»ºåŒ…å«åœ°å›¾ç»˜åˆ¶é¢˜çš„è¯•å·
3. è¿›è¡Œè€ƒè¯•å¹¶åœ¨åœ°å›¾ä¸Šç»˜åˆ¶å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡è®°ã€çº¿æ¡ç­‰ï¼‰
4. è°ƒæ•´åœ°å›¾çš„ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«
5. æäº¤è€ƒè¯•
6. ä½¿ç”¨æ•™å¸ˆè´¦å·è¿›å…¥è¯„åˆ†ç•Œé¢
7. éªŒè¯åœ°å›¾æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºå­¦ç”Ÿç»˜åˆ¶çš„å†…å®¹å’Œåœ°å›¾çŠ¶æ€

### 2. æ•°æ®éªŒè¯
1. æ£€æŸ¥æ•°æ®åº“ä¸­ `AnswerRecords` è¡¨çš„ä»¥ä¸‹å­—æ®µï¼š
   - `MapDrawingData`: åº”åŒ…å«å®Œæ•´çš„JSONæ•°æ®
   - `MapCenter`: åº”åŒ…å«åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡
   - `MapZoom`: åº”åŒ…å«åœ°å›¾ç¼©æ”¾çº§åˆ«

### 3. è¾¹ç•Œæµ‹è¯•
- æµ‹è¯•æ²¡æœ‰ç»˜åˆ¶å†…å®¹çš„åœ°å›¾é¢˜
- æµ‹è¯•åªæœ‰ä¸­å¿ƒç‚¹æ²¡æœ‰ç¼©æ”¾çš„æƒ…å†µ
- æµ‹è¯•æ•°æ®è§£æå¼‚å¸¸çš„å¤„ç†

## âœ… é¡¹ç›®æ„å»ºç»“æœ
```
è¿˜åŸå®Œæˆ(0.4)
  ExamSystem.Domain å·²æˆåŠŸ (0.1 ç§’)
  ExamSystem.Infrastructure å·²æˆåŠŸ (0.1 ç§’)
  ExamSystem.Services å·²æˆåŠŸ (0.1 ç§’)
  ExamSystem.WPF å·²æˆåŠŸ (0.3 ç§’)

åœ¨ 1.1 ç§’å†…ç”Ÿæˆ å·²æˆåŠŸ
```

## ğŸ‰ é¢„æœŸæ•ˆæœ

ä¿®å¤å®Œæˆåï¼Œåœ°å›¾ç»˜åˆ¶é¢˜çš„æ•°æ®å°†åŒ…å«å®Œæ•´ä¿¡æ¯ï¼š

**ä¿®å¤å‰çš„æ•°æ®**:
```json
[{"ShapeType": "marker", "Coordinates": [...], "Label": "æ ‡è®°1"}]
```

**ä¿®å¤åçš„æ•°æ®**:
```json
{
  "overlays": [{"ShapeType": "marker", "Coordinates": [...], "Label": "æ ‡è®°1"}],
  "center": {"lng": 106.63, "lat": 26.65},
  "zoom": 12
}
```

è¿™æ ·æ•™å¸ˆåœ¨è¯„åˆ†æ—¶å°±èƒ½çœ‹åˆ°å­¦ç”Ÿç­”é¢˜æ—¶çš„å®Œæ•´åœ°å›¾çŠ¶æ€ï¼ŒåŒ…æ‹¬åœ°å›¾çš„ä¸­å¿ƒä½ç½®å’Œç¼©æ”¾çº§åˆ«ï¼Œæä¾›æ›´å‡†ç¡®çš„è¯„åˆ†ä¾æ®ã€‚

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2024å¹´11æœˆ
**ä¿®æ”¹æ–‡ä»¶**: 
- `ExamSystem.WPF/ViewModels/FullScreenExamViewModel.cs`
**éªŒè¯çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡ï¼ŒåŠŸèƒ½å®Œæ•´