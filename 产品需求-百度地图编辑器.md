# 百度地图编辑器功能需求文档（WPF本地实现版，含考试题型：地图绘制）

## 一、背景与目标
在已有“百度地图编辑器”基础能力之上，新增一类考试题型：地图绘制题。教师出题时提供题目描述，并可在地图上预先添加“标准（参考）标记/图形”，同时在地图上预设“辅助指引标记/图形”，用于引导考生作图。学生在作答时根据题目要求在地图上绘制对应的标记或几何图形进行回答。

重要变更：
- 本题型只支持人工评分（教师阅卷），不进行自动或半自动评分。

目标：
- 将地图编辑器扩展为“考试题型工具”，支持教师侧题目编辑与学生侧作答。
- 支持教师在地图上配置参考答案（标记、折线/水带、多边形、矩形、圆等）、配置辅助指引标记/图形，并设置作答约束。
- 学生按照题目要求绘制对应图形并提交，成绩由教师人工批改后生成。
- 与现有考试系统集成（题库、试卷、阅卷、成绩回显）。

## 二、用户与使用场景
- 教师（出题/阅卷）：创建地图绘制题，配置参考答案与辅助指引图层，设置作答约束；考试结束后人工阅卷并打分。
- 学生（作答）：阅读题目描述，在地图上绘制要求的图形或标记，提交答案，等待教师批改结果。
- 管理员（运维/监督）：配置权限，查看统计与日志，保证数据与资源管理合规。

## 三、角色与流程
### 3.1 教师端流程
1) 选择题型“地图绘制题”并进入地图编辑器出题页面。
2) 填写题目基础信息：题目标题、题目描述、城市、底图类型、是否显示路网、答题时限（可选）。
3) 在地图上“添加参考答案图形”（仅教师可见，学生不可见）：
   - 支持类型：标记（点）、水带/折线（polyline）、多边形、矩形、圆。
   - 支持设置样式：边框色、填充色、线宽、透明度、图标（仅用于教师参考，不参与自动评分）。
   - 支持为参考图形命名（便于阅卷分项对照）。
4) 在地图上“添加辅助指引标记/图形”（学生端可见，用于作图引导）：
   - 类型同上，常见用法：起点/终点标记、路径参考点、边界线、提示区域等。
   - 可配置是否在学生端显示/隐藏；学生不可编辑、不可删除。
5) 配置作答约束：
   - 允许的绘图工具（例如仅允许“标记”和“折线”）。
   - 图形数量约束（例如必须绘制 1 个圆与 1 条折线；支持固定/至少/至多三种模式）。
   - 是否要求样式一致（颜色/线宽等是否纳入教师评分参考）。
6) 保存题目至题库或直接加入试卷；考试结束进入阅卷页面进行人工评分。

### 3.2 学生端流程
1) 打开试卷中的地图绘制题，加载题目描述与地图场景，并显示辅助指引图层（若教师设置为可见）。
2) 根据题目要求，选择允许的绘图工具，在地图上进行绘制（标记、折线、多边形、矩形、圆等）。
3) 查看“已绘制图形”列表，支持删除重画；达到数量/类型约束后方可提交。
4) 提交答案：系统保存学生绘制的所有覆盖物；成绩需待教师人工批改后回显。

## 四、地图编辑器基础能力（沿用与优化）
- 地图容器：#edit-baidu-container，基于百度地图 JS API。
- 城市中心定位：支持城市选择并居中到预置坐标，缩放默认 11 级；可配置题目打开时默认中心与缩放级别。
- 底图切换：卫星/矢量；路网叠加开关。
- 建筑数据展示：消防队站(dz)、专职队(zz)、重点建筑(zd) 的显示与计数（用于教学或题面参考，可在出题时选择是否在学生端显示）。
- 覆盖物绘制工具：标记、折线（水带纹理可选）、多边形、矩形、圆；边框色/填充色/线宽可设置；支持停止绘图与全部删除；支持覆盖物列表重命名与删除。
- 水带纹理：折线可叠加纹理与头部标记，表示方向；纹理加载前显示临时线，加载后使用 pattern 重绘。
- 图标选择：绘制“标记”时可选择分类/图标，应用到后续新增标记。


## 六、UI/交互详述
### 6.1 教师端出题页面
- 顶部：题目标题、描述输入；城市选择、底图类型（卫星/矢量）、路网开关；默认中心定位输入。
- 左侧：建筑数据层显示开关与计数（dz/zz/zd），可选择是否在学生端显示。
- 中部地图：
  - 工具栏：选择绘图工具；颜色与线宽设置；纹理开关（水带可选）；图标选择弹窗（标记）。
  - 参考答案图层：已添加参考图形的列表，支持重命名、删除；学生端不可见。
  - 辅助指引图层：已添加指引图形的列表，支持重命名、删除、显示/隐藏；学生端可见且锁定。
- 底部：作答约束设置（allowedTools、requiredOverlays、timeLimitSeconds）。
- 右侧：预览/保存按钮；保存成功后可加入试卷；考试结束后进入“阅卷页面”。

### 6.2 学生端作答页面
- 顶部：题目标题与描述；剩余时间（若有限时）。
- 地图：按 allowedTools 提供绘图工具；若 requiredOverlays 指定数量与类型，列表需提示“尚需绘制 X 条折线/1 个圆”等。
- 辅助指引图层：显示教师预设的标记/图形；学生不可编辑；可提供显示/隐藏开关（若题目允许）。
- 已绘制图形列表：支持删除重画；达到约束条件后启用“提交”。
- 提交后：显示提交成功；成绩待教师批改后回显（不即时显示分项评分）。

### 6.3 阅卷页面（教师人工评分）
- 参考答案 vs 学生答案对比视图：
  - 叠加/分屏对比；透明度调节；图层开关。
  - 几何差异辅助工具（可选）：显示点位偏差、线段差异热力、面积重叠区域，仅作为辅助，不自动计分。
- 评分录入：
  - 按 reviewRubric 分项录分或录入总分；支持备注。
  - 支持通过/不通过标签或等级评定。
- 提交评分：生成成绩与反馈，可退回重批或二次复核（可选）。

## 七、人工评分（Rubric）与建议判定参考
说明：本题型仅人工评分；以下指标仅为教师判定的参考信息或辅助可视化工具，不用于自动计分。
- 标记（点）：与参考点的距离偏差（米）。
- 折线（水带）：路径相似度（例如平均垂距/Fréchet 距离的可视化对照）。
- 多边形：重叠面积比例（IoU）的可视化对照。
- 矩形：角点位置偏差与倾角对照；或与参考矩形 IoU 可视化。
- 圆：圆心距离偏差与半径差的可视化。
- 样式：颜色/线宽等是否符合题面要求（作为评分参考项）。

## 八、作答约束与规则
- 工具限制：仅可使用 allowedTools 中的工具。
- 数量限制：requiredOverlays 支持“固定/至少/至多”三种模式。
- 编辑限制：可限制学生是否允许重命名或修改样式。
- 时间限制：timeLimitSeconds 超时自动提交或禁止提交（由试卷设置）。
- 视图限制：参考答案图层仅教师可见；辅助指引图层可在学生端显示；学生无法访问或导出参考答案。



## 十、权限与安全
- 教师权限：创建/编辑地图绘制题、查看参考答案、阅卷与提交评分。
- 学生权限：仅在考试窗口内作答与提交。
- 防作弊：
  - 作答页面只读题面参数；禁止访问教师参考答案图层。
  - 记录作答时长与操作日志（可选）。

## 十一、性能与兼容
- 大量点位/复杂几何体时的性能优化：简化重绘、抽稀折线、分页加载建筑层。
- Canvas 纹理的重绘频率控制。
- 浏览器兼容：Chrome/Edge（PC）。

## 十二、日志与错误处理
- 接口失败：message 提示并允许重试；保持草稿与本地缓存（教师出题时）。
- 地图未初始化保护：阻止绘制并提示。
- 纹理加载失败：回退为普通折线。

## 十三、验收标准
- 教师端：
  - 能创建“地图绘制题”，保存参考答案图层与辅助指引图层（至少 2 类覆盖物）。
  - 能设置作答约束与评分量表；参考答案在学生端不可见；辅助指引在学生端可见且锁定。
- 学生端：
  - 能按要求绘制指定数量与类型的图形；已绘制列表可删除重画；达到约束后可提交。
  - 提交后不显示自动评分；成绩在教师阅卷后回显。
- 阅卷复核：
  - 教师能对比参考与答案图层（叠加/分屏/透明度调节），录入分数与备注，并提交评分。

## 十四、测试用例建议
- 流程用例：
  - 教师创建题目：添加 1 条参考折线 + 2 个辅助标记；设置允许工具为“折线”；设置数量为“固定 1 条折线”。
  - 学生作答：绘制 1 条折线；提交成功；等待评分。
  - 教师阅卷：打开对比视图；录入分数与备注；提交评分；学生端查看成绩。
- 权限与约束：
  - 学生端无法显示参考答案图层；能看到辅助指引图层且不可编辑。
  - 禁止使用未授权工具；未满足数量约束不可提交。
- 性能与异常：
  - 大量覆盖物绘制与重绘性能；
  - 纹理加载失败回退；
  - 接口失败重试与草稿保存。

## 十五、后续扩展
- 差异可视化增强：点/线/面差异的热力与量化提示（仍为人工评分辅助）。
- 批量导入参考或指引图层（GeoJSON/KML）。
- 覆盖物版本管理与协作出题；阅卷流程的多人复核与仲裁。

—— 完 ——