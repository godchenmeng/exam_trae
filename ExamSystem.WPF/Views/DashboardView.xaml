<UserControl x:Class="ExamSystem.WPF.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:ExamSystem.WPF.Views"
             xmlns:viewModels="clr-namespace:ExamSystem.WPF.ViewModels"
             xmlns:domain="clr-namespace:ExamSystem.Domain.Enums;assembly=ExamSystem.Domain"
             xmlns:lvc="http://livecharts.com"
             xmlns:lvcwpf="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             mc:Ignorable="d"
             d:DesignWidth="1000" d:DesignHeight="700"
             Loaded="UserControl_Loaded">
    <UserControl.Resources>
        <DataTemplate x:Key="ActivityItemTemplate" DataType="{x:Type viewModels:RecentActivityModel}">
            <Border Padding="10" Margin="0,5" Background="#F9FAFB" CornerRadius="6">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding Icon}" FontSize="16" Margin="0,0,10,0"/>
                    <StackPanel>
                        <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                        <TextBlock Text="{Binding Description}" Foreground="#6B7280"/>
                        <TextBlock Text="{Binding Time}" Foreground="#9CA3AF" FontSize="12"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- è§’è‰²æ¨¡å—å¯è§æ€§æ ·å¼ -->
        <Style x:Key="RolePanelStyle" TargetType="FrameworkElement">
            <Setter Property="Visibility" Value="Collapsed"/>
        </Style>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
    <Grid Background="{StaticResource SurfaceBrush}" Margin="{StaticResource SpacingXL}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- æ¬¢è¿Žä¿¡æ¯ -->
        <TextBlock Grid.Row="0" Text="{Binding WelcomeMessage}" Style="{StaticResource TitleText}"/>

        <!-- KPI å¡ç‰‡ï¼šæŒ‰è§’è‰²æ˜¾ç¤º -->
        <!-- æ•™å¸ˆ KPI -->
        <UniformGrid x:Name="TeacherKpiGrid" Grid.Row="1" Columns="4" Margin="0,10,0,10">
            <UniformGrid.Style>
                <Style TargetType="UniformGrid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Teacher}">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </UniformGrid.Style>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„é¢˜åº“" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding MyQuestionBankCount}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„é¢˜ç›®" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding MyQuestionCount}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„è¯•å·ï¼ˆå‘å¸ƒä¸­ï¼‰" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding MyExamPaperCount}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„å¹³å‡åˆ†/é€šè¿‡çŽ‡" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding MyAverageScore, StringFormat=å¹³å‡åˆ†ï¼š{0:F1}}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
        </UniformGrid>

        <!-- å­¦ç”Ÿ KPI -->
        <UniformGrid x:Name="StudentKpiGrid" Grid.Row="1" Columns="4" Margin="0,10,0,10">
            <UniformGrid.Style>
                <Style TargetType="UniformGrid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Student}">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </UniformGrid.Style>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="å¯å‚åŠ è€ƒè¯•æ•°" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding AvailableExamCount}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="å·²å®Œæˆè€ƒè¯•æ•°" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding CompletedExamCount}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„å¹³å‡åˆ†ï¼ˆ30å¤©ï¼‰" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding AverageScore, StringFormat={}{0:F1}}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource KpiCard}">
                <StackPanel>
                    <TextBlock Text="æˆ‘çš„é€šè¿‡çŽ‡ï¼ˆ30å¤©ï¼‰" Style="{StaticResource KpiTitleText}"/>
                    <TextBlock Text="{Binding PassRate, StringFormat={}{0:P0}}" Style="{StaticResource KpiValueText}"/>
                </StackPanel>
            </Border>
        </UniformGrid>

        <!-- å¿«é€Ÿæ“ä½œï¼šæŒ‰è§’è‰²æ˜¾ç¤º -->
        <!-- æ•™å¸ˆæ“ä½œåŒº -->
        <StackPanel x:Name="TeacherActions" Grid.Row="2">
            <StackPanel.Style>
                <Style TargetType="StackPanel" BasedOn="{StaticResource Toolbar}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Teacher}">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </StackPanel.Style>
            <Button Style="{StaticResource ActionButtonStyle}" Content="æ–°å»ºé¢˜åº“" Click="CreateQuestionBankButton_Click"/>
            <Button Style="{StaticResource ActionButtonStyle}" Content="æ·»åŠ é¢˜ç›®" Click="AddQuestionButton_Click"/>
            <Button Style="{StaticResource ActionButtonStyle}" Content="åˆ›å»ºè¯•å·" Click="CreateExamPaperButton_Click"/>
            <Button Style="{StaticResource ActionButtonStyle}" Content="æŸ¥çœ‹ç»Ÿè®¡" Click="ViewStatisticsButton_Click"/>
        </StackPanel>

        <!-- å­¦ç”Ÿæ“ä½œåŒº -->
        <StackPanel x:Name="StudentActions" Grid.Row="2">
            <StackPanel.Style>
                <Style TargetType="StackPanel" BasedOn="{StaticResource Toolbar}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Student}">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </StackPanel.Style>
            <!--<Button Style="{StaticResource ActionButtonStyle}" Content="æŸ¥çœ‹ç»Ÿè®¡" Click="ViewStatisticsButton_Click"/>
            <Button Style="{StaticResource ActionButtonStyle}" Content="å¸®åŠ©æ–‡æ¡£" Click="HelpDocumentButton_Click"/>-->
        </StackPanel>

        <!-- è§’è‰²ä¸“å±žæ¨¡å— -->
        <Border Grid.Row="3" Style="{StaticResource CardStyle}" Margin="0,10,0,10">
            <StackPanel>
                <!-- ç®¡ç†å‘˜æ¨¡å—ç§»é™¤ï¼ˆæŒ‰åŽŸåž‹æ¸…é™¤ä¸Žæ•™å¸ˆ/å­¦ç”Ÿä¸ç›¸å…³å†…å®¹ï¼‰ -->
                <StackPanel x:Name="AdminPanel">
                     <StackPanel.Style>
                         <Style TargetType="StackPanel" BasedOn="{StaticResource RolePanelStyle}">
                             <Style.Triggers>
                                 <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Admin}">
                                     <Setter Property="Visibility" Value="Visible"/>
                                 </DataTrigger>
                             </Style.Triggers>
                         </Style>
                     </StackPanel.Style>
                     <TextBlock Text="ç®¡ç†å‘˜æ¦‚è§ˆ" FontWeight="Bold" FontSize="16" Margin="0,0,0,8"/>
                     
                     <!-- ç®¡ç†å‘˜æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                     <TextBlock Text="ç®¡ç†æ“ä½œ" FontWeight="Bold" FontSize="14" Margin="0,0,0,8"/>
                     <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                         <Button Style="{StaticResource ActionButtonStyle}" Content="ç”¨æˆ·ç®¡ç†" Click="UserManagementButton_Click" Margin="0,0,10,0"/>
                         <Button Style="{StaticResource ActionButtonStyle}" Content="å»ºç­‘ç‰©ç®¡ç†" Click="BuildingManagementButton_Click" Margin="0,0,10,0"/>
                         <!--<Button Style="{StaticResource ActionButtonStyle}" Content="ç³»ç»Ÿè®¾ç½®" Click="SystemSettingsButton_Click" Margin="0,0,10,0"/>
                         <Button Style="{StaticResource ActionButtonStyle}" Content="æ•°æ®å¤‡ä»½" Click="DataBackupButton_Click"/>-->
                     </StackPanel>
                     
                     <UniformGrid Columns="4" Rows="2" Margin="0,5,0,10">
                         <StackPanel>
                             <TextBlock Text="ç³»ç»Ÿç”¨æˆ·"/>
                             <TextBlock Text="{Binding TotalUsers}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="æ´»è·ƒç”¨æˆ·"/>
                             <TextBlock Text="{Binding ActiveUsers}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="é”å®šç”¨æˆ·"/>
                             <TextBlock Text="{Binding LockedUsers}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="ç®¡ç†å‘˜æ•°"/>
                             <TextBlock Text="{Binding AdminCount}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="æ•™å¸ˆæ•°"/>
                             <TextBlock Text="{Binding TeacherCount}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="å­¦ç”Ÿæ•°"/>
                             <TextBlock Text="{Binding StudentCount}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="å·²å‘å¸ƒè¯•å·"/>
                             <TextBlock Text="{Binding PublishedPaperCount}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                         <StackPanel>
                             <TextBlock Text="æœªå‘å¸ƒè¯•å·"/>
                             <TextBlock Text="{Binding UnpublishedPaperCount}" FontSize="20" FontWeight="Bold"/>
                         </StackPanel>
                     </UniformGrid>
                     <!-- ç®¡ç†å‘˜è¶‹åŠ¿åŒºå›¾è¡¨ï¼ˆè¿‘7å¤©ï¼‰ -->
                     <TextBlock Text="è¶‹åŠ¿åŒºï¼ˆè¿‘7å¤©ï¼‰" FontWeight="Bold" FontSize="16" Margin="0,10,0,8"/>
                      <Border x:Name="AdminTrendChartHost" Style="{StaticResource CardStyle}" Margin="0,0,0,10">
                          <lvcwpf:CartesianChart Height="220"
                                                Series="{Binding AdminTrendSeries}"
                                                XAxes="{Binding AdminTrendXAxes}"/>
                      </Border>
                 </StackPanel>

                 <!-- æ•™å¸ˆæ¨¡å—ï¼šè¯•å·æŽ’è¡Œæ¦œ + è¡¨çŽ°å›¾è¡¨ + å¾…æ‰¹é˜…é˜Ÿåˆ— -->
                 <StackPanel x:Name="TeacherPanel">
                     <StackPanel.Style>
                         <Style TargetType="StackPanel" BasedOn="{StaticResource RolePanelStyle}">
                             <Style.Triggers>
                                 <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Teacher}">
                                     <Setter Property="Visibility" Value="Visible"/>
                                 </DataTrigger>
                             </Style.Triggers>
                         </Style>
                     </StackPanel.Style>
                     <TextBlock Text="æˆ‘çš„è¯•å·æŽ’è¡Œæ¦œ" FontWeight="Bold" FontSize="16" Margin="0,0,0,8"/>
                     <ListView ItemsSource="{Binding TeacherTopPapers}" Height="180" Style="{StaticResource ModernListView}">
                         <ListView.View>
                             <GridView AllowsColumnReorder="False">
                                 <GridViewColumn Header="è¯•å·" DisplayMemberBinding="{Binding PaperName}" Width="220"/>
                                 <GridViewColumn Header="å¹³å‡åˆ†" DisplayMemberBinding="{Binding AverageScore}" Width="100"/>
                                 <GridViewColumn Header="é€šè¿‡çŽ‡" DisplayMemberBinding="{Binding PassRate}" Width="100"/>
                             </GridView>
                         </ListView.View>
                     </ListView>
                     <!-- æ•™å¸ˆè¯•å·è¡¨çŽ°å›¾è¡¨ï¼ˆå¹³å‡åˆ†ï¼‰ -->
                     <TextBlock Text="è¯•å·è¡¨çŽ°å›¾è¡¨ï¼ˆå¹³å‡åˆ†ï¼‰" FontWeight="Bold" FontSize="16" Margin="0,10,0,8"/>
                      <Border x:Name="TeacherPerformanceChartHost" Style="{StaticResource CardStyle}" Margin="0,0,0,10">
                          <lvcwpf:CartesianChart Height="220"
                                                Series="{Binding TeacherPerformanceSeries}"
                                                XAxes="{Binding TeacherPerformanceXAxes}"/>
                      </Border>

                     <!-- å¾…æ‰¹é˜…é˜Ÿåˆ—ï¼ˆå ä½ï¼‰ -->
                     <TextBlock Text="å¾…æ‰¹é˜…é˜Ÿåˆ—" FontWeight="Bold" FontSize="16" Margin="0,10,0,8"/>
                     <Grid>
                         <Grid.RowDefinitions>
                             <RowDefinition Height="Auto"/>
                             <RowDefinition Height="*"/>
                         </Grid.RowDefinitions>
                         <ListView Grid.Row="1" ItemsSource="{Binding TeacherPendingGradings}" Height="180" Style="{StaticResource ModernListView}">
                             <ListView.View>
                                 <GridView AllowsColumnReorder="False">
                                     <GridViewColumn Header="è¯•å·" DisplayMemberBinding="{Binding PaperName}" Width="220"/>
                                     <GridViewColumn Header="æœªè¯„åˆ†æ•°" DisplayMemberBinding="{Binding PendingCount}" Width="120"/>
                                     <GridViewColumn Header="æœ€è¿Ÿæäº¤æ—¶é—´" DisplayMemberBinding="{Binding DueDate}" Width="160"/>
                                 </GridView>
                             </ListView.View>
                         </ListView>
                         <TextBlock Grid.Row="0" Text="å½“å‰æš‚æ— å¾…æ‰¹é˜…è®°å½•" Foreground="#6B7280">
                             <TextBlock.Style>
                                 <Style TargetType="TextBlock">
                                     <Setter Property="Visibility" Value="Collapsed"/>
                                     <Style.Triggers>
                                         <DataTrigger Binding="{Binding ElementName=TeacherPanel, Path=DataContext.TeacherPendingGradings.Count}" Value="0">
                                             <Setter Property="Visibility" Value="Visible"/>
                                         </DataTrigger>
                                     </Style.Triggers>
                                 </Style>
                             </TextBlock.Style>
                         </TextBlock>
                     </Grid>
                 </StackPanel>

                 <!-- å­¦ç”Ÿæ¨¡å—ï¼šå¾…å‚åŠ ä¸Žè¿‘æœŸæˆç»©ï¼ˆä¿æŒï¼‰ -->
                 <StackPanel x:Name="StudentPanel">
                     <StackPanel.Style>
                         <Style TargetType="StackPanel" BasedOn="{StaticResource RolePanelStyle}">
                             <Style.Triggers>
                                 <DataTrigger Binding="{Binding CurrentRole}" Value="{x:Static domain:UserRole.Student}">
                                     <Setter Property="Visibility" Value="Visible"/>
                                 </DataTrigger>
                             </Style.Triggers>
                         </Style>
                     </StackPanel.Style>
                     <TextBlock Text="å¾…å‚åŠ è€ƒè¯•" FontWeight="Bold" FontSize="16" Margin="0,0,0,8"/>
                     <ItemsControl ItemsSource="{Binding StudentUpcomingExams}">
                         <ItemsControl.ItemTemplate>
                             <DataTemplate>
                                 <Border Padding="10" Margin="0,5" Background="{StaticResource MutedBackgroundBrush}" CornerRadius="6">
                                     <StackPanel Orientation="Horizontal">
                                         <TextBlock Text="ðŸ“" FontSize="16" Margin="0,0,10,0"/>
                                         <StackPanel>
                                             <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                                             <TextBlock Text="{Binding StartTime, StringFormat=å¼€å§‹æ—¶é—´ï¼š{0:yyyy-MM-dd HH:mm}}" Foreground="#6B7280"/>
                                         </StackPanel>
                                     </StackPanel>
                                 </Border>
                             </DataTemplate>
                         </ItemsControl.ItemTemplate>
                     </ItemsControl>

                     <TextBlock Text="è¿‘æœŸè€ƒè¯•æˆç»©" FontWeight="Bold" FontSize="16" Margin="10,10,0,8"/>
                     <ListView ItemsSource="{Binding StudentRecentResults}" Height="180" Style="{StaticResource ModernListView}">
                         <ListView.View>
                             <GridView AllowsColumnReorder="False">
                                 <GridViewColumn Header="è¯•å·" DisplayMemberBinding="{Binding PaperName}" Width="220"/>
                                 <GridViewColumn Header="å¾—åˆ†" DisplayMemberBinding="{Binding Score}" Width="100"/>
                                 <GridViewColumn Header="é€šè¿‡" DisplayMemberBinding="{Binding IsPassed}" Width="80"/>
                                 <GridViewColumn Header="è€ƒè¯•æ—¶é—´" DisplayMemberBinding="{Binding ExamTime}" Width="160"/>
                             </GridView>
                         </ListView.View>
                     </ListView>
                 </StackPanel>
            </StackPanel>
        </Border>

        <Border Grid.Row="4" Style="{StaticResource CardStyle}">
            <StackPanel>
                <TextBlock Text="æœ€è¿‘æ´»åŠ¨" FontWeight="Bold" FontSize="16" Margin="0,0,0,8"/>
                <ListView ItemsSource="{Binding RecentActivities}" ItemTemplate="{StaticResource ActivityItemTemplate}"/>
            </StackPanel>
        </Border>
        </Grid>
     </ScrollViewer>
 </UserControl>