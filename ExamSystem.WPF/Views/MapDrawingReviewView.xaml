<UserControl x:Class="ExamSystem.WPF.Views.MapDrawingReviewView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    
    <UserControl.Resources>
        <!-- 标题样式 -->
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#2c3e50"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>
        
        <!-- 信息文本样式 -->
        <Style x:Key="InfoTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="#34495e"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
        </Style>
        
        <!-- 按钮样式 -->
        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- 主要按钮样式 -->
        <Style x:Key="PrimaryButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
            <Setter Property="Background" Value="#3498db"/>
            <Setter Property="BorderBrush" Value="#2980b9"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <!-- 成功按钮样式 -->
        <Style x:Key="SuccessButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
            <Setter Property="Background" Value="#27ae60"/>
            <Setter Property="BorderBrush" Value="#229954"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <!-- 警告按钮样式 -->
        <Style x:Key="WarningButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
            <Setter Property="Background" Value="#f39c12"/>
            <Setter Property="BorderBrush" Value="#e67e22"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <!-- 面板样式 -->
        <Style x:Key="PanelStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#bdc3c7"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="5"/>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 顶部信息栏 -->
        <Border Grid.Row="0" Style="{StaticResource PanelStyle}" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- 题目信息 -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="{Binding QuestionTitle}" Style="{StaticResource HeaderTextStyle}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="学生：" Style="{StaticResource InfoTextStyle}"/>
                        <TextBlock Text="{Binding StudentName}" Style="{StaticResource InfoTextStyle}" FontWeight="Bold"/>
                        <TextBlock Text="  |  学号：" Style="{StaticResource InfoTextStyle}" Margin="10,0,0,0"/>
                        <TextBlock Text="{Binding StudentId}" Style="{StaticResource InfoTextStyle}" FontWeight="Bold"/>
                        <TextBlock Text="  |  提交时间：" Style="{StaticResource InfoTextStyle}" Margin="10,0,0,0"/>
                        <TextBlock Text="{Binding SubmitTime}" Style="{StaticResource InfoTextStyle}"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- 操作按钮 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="重置视图" Command="{Binding ResetViewCommand}" Style="{StaticResource PrimaryButtonStyle}"/>
                    <Button Content="切换模式" Command="{Binding ToggleViewModeCommand}" Style="{StaticResource WarningButtonStyle}"/>
                    <Button Content="保存评分" Command="{Binding SaveScoreCommand}" Style="{StaticResource SuccessButtonStyle}"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- 主要内容区域 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="300"/>
            </Grid.ColumnDefinitions>
            
            <!-- 地图对比区域 -->
            <Border Grid.Column="0" Style="{StaticResource PanelStyle}" Margin="0,0,5,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- 视图模式切换 -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <RadioButton x:Name="SideBySideMode" Content="并排对比" IsChecked="{Binding IsSideBySideMode}" 
                                   GroupName="ViewMode" Margin="0,0,20,0"/>
                        <RadioButton x:Name="OverlayMode" Content="叠加对比" IsChecked="{Binding IsOverlayMode}" 
                                   GroupName="ViewMode" Margin="0,0,20,0"/>
                        <RadioButton x:Name="SwitchMode" Content="切换对比" IsChecked="{Binding IsSwitchMode}" 
                                   GroupName="ViewMode"/>
                    </StackPanel>
                    
                    <!-- 地图容器 -->
                    <Grid Grid.Row="1">
                        <!-- 并排模式 -->
                        <Grid x:Name="SideBySideContainer" Visibility="{Binding SideBySideVisibility}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- 参考答案地图 -->
                            <Border Grid.Column="0" BorderBrush="#27ae60" BorderThickness="2" CornerRadius="4">
                                <Grid>
                                    <wv2:WebView2 x:Name="ReferenceMapWebView" 
                                                NavigationCompleted="ReferenceMapWebView_NavigationCompleted"
                                                Panel.ZIndex="-1"/>
                                    <TextBlock Text="参考答案" HorizontalAlignment="Left" VerticalAlignment="Top" 
                                             Background="#27ae60" Foreground="White" Padding="8,4" 
                                             FontWeight="Bold" Margin="10"/>
                                    
                                    <!-- 加载遮罩 -->
                                    <Grid Background="White" Opacity="0.9" 
                                          Visibility="{Binding IsReferenceMapLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <ProgressBar IsIndeterminate="True" Width="100" Height="4" Margin="0,0,0,10"/>
                                            <TextBlock Text="加载参考答案..." HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>
                            
                            <!-- 分隔线 -->
                            <Rectangle Grid.Column="1" Fill="#bdc3c7"/>
                            
                            <!-- 学生答案地图 -->
                            <Border Grid.Column="2" BorderBrush="#3498db" BorderThickness="2" CornerRadius="4">
                                <Grid>
                                    <wv2:WebView2 x:Name="StudentMapWebView" 
                                                NavigationCompleted="StudentMapWebView_NavigationCompleted"
                                                Panel.ZIndex="-1"/>
                                    <TextBlock Text="学生答案" HorizontalAlignment="Left" VerticalAlignment="Top" 
                                             Background="#3498db" Foreground="White" Padding="8,4" 
                                             FontWeight="Bold" Margin="10"/>
                                    
                                    <!-- 加载遮罩 -->
                                    <Grid Background="White" Opacity="0.9" 
                                          Visibility="{Binding IsStudentMapLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <ProgressBar IsIndeterminate="True" Width="100" Height="4" Margin="0,0,0,10"/>
                                            <TextBlock Text="加载学生答案..." HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>
                        </Grid>
                        
                        <!-- 叠加/切换模式 -->
                        <Border x:Name="OverlayContainer" BorderBrush="#34495e" BorderThickness="2" CornerRadius="4"
                                Visibility="{Binding OverlayVisibility}">
                            <Grid>
                                <wv2:WebView2 x:Name="ComparisonMapWebView" 
                                            NavigationCompleted="ComparisonMapWebView_NavigationCompleted"
                                            Panel.ZIndex="-1"/>
                                
                                <!-- 图层控制面板 -->
                                <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" 
                                          Background="White" Opacity="0.95">
                                    <Border BorderBrush="#bdc3c7" BorderThickness="1" CornerRadius="4" Padding="10">
                                        <StackPanel>
                                            <TextBlock Text="图层控制" FontWeight="Bold" Margin="0,0,0,10"/>
                                            <CheckBox Content="显示参考答案" IsChecked="{Binding ShowReferenceLayer}" 
                                                    Foreground="#27ae60" FontWeight="Medium" Margin="0,0,0,5"/>
                                            <CheckBox Content="显示学生答案" IsChecked="{Binding ShowStudentLayer}" 
                                                    Foreground="#3498db" FontWeight="Medium" Margin="0,0,0,5"/>
                                            <CheckBox Content="显示指引图层" IsChecked="{Binding ShowGuideLayer}" 
                                                    Foreground="#f39c12" FontWeight="Medium"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                                
                                <!-- 加载遮罩 -->
                                <Grid Background="White" Opacity="0.9" 
                                      Visibility="{Binding IsComparisonMapLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                        <ProgressBar IsIndeterminate="True" Width="100" Height="4" Margin="0,0,0,10"/>
                                        <TextBlock Text="加载对比地图..." HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </Border>
            
            <!-- 右侧评分面板 -->
            <Border Grid.Column="1" Style="{StaticResource PanelStyle}" Margin="5,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- 评分标准 -->
                        <TextBlock Text="评分标准" Style="{StaticResource HeaderTextStyle}"/>
                        <ItemsControl ItemsSource="{Binding ReviewRubric}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#ecf0f1" Padding="10" Margin="0,0,0,5" CornerRadius="4">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Criterion}" FontWeight="Bold" Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding Description}" TextWrapping="Wrap" 
                                                     Foreground="#7f8c8d" FontSize="12"/>
                                            <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                                <TextBlock Text="分值：" FontSize="12"/>
                                                <TextBlock Text="{Binding MaxScore}" FontWeight="Bold" FontSize="12"/>
                                                <TextBlock Text="分" FontSize="12"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- 评分输入 -->
                        <TextBlock Text="评分详情" Style="{StaticResource HeaderTextStyle}" Margin="0,20,0,10"/>
                        <ItemsControl ItemsSource="{Binding ScoreItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="White" BorderBrush="#bdc3c7" BorderThickness="1" 
                                          Padding="10" Margin="0,0,0,10" CornerRadius="4">
                                        <StackPanel>
                                            <TextBlock Text="{Binding CriterionName}" FontWeight="Bold" Margin="0,0,0,5"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Slider Grid.Column="0" Minimum="0" Maximum="{Binding MaxScore}" 
                                                      Value="{Binding Score}" TickFrequency="1" IsSnapToTickEnabled="True"
                                                      Margin="0,0,10,0"/>
                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <TextBox Text="{Binding Score}" Width="40" TextAlignment="Center"/>
                                                    <TextBlock Text="/" Margin="5,0"/>
                                                    <TextBlock Text="{Binding MaxScore}"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- 总分显示 -->
                        <Border Background="#3498db" Padding="15" Margin="0,10,0,0" CornerRadius="4">
                            <StackPanel>
                                <TextBlock Text="总分" Foreground="White" FontWeight="Bold" FontSize="16" 
                                         HorizontalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,5,0,0">
                                    <TextBlock Text="{Binding TotalScore}" Foreground="White" FontWeight="Bold" 
                                             FontSize="24"/>
                                    <TextBlock Text=" / " Foreground="White" FontSize="20" Margin="5,0"/>
                                    <TextBlock Text="{Binding MaxTotalScore}" Foreground="White" FontSize="20"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                        
                        <!-- 评语输入 -->
                        <TextBlock Text="评语" Style="{StaticResource HeaderTextStyle}" Margin="0,20,0,10"/>
                        <TextBox Text="{Binding Comments}" TextWrapping="Wrap" AcceptsReturn="True" 
                               Height="100" VerticalScrollBarVisibility="Auto" 
                               BorderBrush="#bdc3c7" Padding="8"/>
                        
                        <!-- 统计信息 -->
                        <TextBlock Text="统计信息" Style="{StaticResource HeaderTextStyle}" Margin="0,20,0,10"/>
                        <Border Background="#ecf0f1" Padding="10" CornerRadius="4">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <TextBlock Text="参考答案图形数：" Width="120"/>
                                    <TextBlock Text="{Binding ReferenceShapeCount}" FontWeight="Bold"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <TextBlock Text="学生答案图形数：" Width="120"/>
                                    <TextBlock Text="{Binding StudentShapeCount}" FontWeight="Bold"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <TextBlock Text="匹配度：" Width="120"/>
                                    <TextBlock Text="{Binding MatchPercentage}" FontWeight="Bold" Foreground="#27ae60"/>
                                    <TextBlock Text="%" FontWeight="Bold" Foreground="#27ae60"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="评分时间：" Width="120"/>
                                    <TextBlock Text="{Binding ReviewTime}"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- 底部操作栏 -->
        <Border Grid.Row="2" Background="#f8f9fa" BorderBrush="#dee2e6" BorderThickness="0,1,0,0" 
                Padding="15,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- 状态信息 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="状态：" Foreground="#6c757d"/>
                    <TextBlock Text="{Binding ReviewStatus}" FontWeight="Bold" Margin="5,0,0,0"/>
                    <TextBlock Text="  |  最后保存：" Foreground="#6c757d" Margin="20,0,0,0"/>
                    <TextBlock Text="{Binding LastSaveTime}" Margin="5,0,0,0"/>
                </StackPanel>
                
                <!-- 操作按钮 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="上一份" Command="{Binding PreviousAnswerCommand}" 
                          Style="{StaticResource ActionButtonStyle}" Background="#6c757d" 
                          BorderBrush="#5a6268" Foreground="White"/>
                    <Button Content="下一份" Command="{Binding NextAnswerCommand}" 
                          Style="{StaticResource ActionButtonStyle}" Background="#6c757d" 
                          BorderBrush="#5a6268" Foreground="White"/>
                    <Button Content="保存并继续" Command="{Binding SaveAndContinueCommand}" 
                          Style="{StaticResource SuccessButtonStyle}"/>
                    <Button Content="完成评分" Command="{Binding CompleteReviewCommand}" 
                          Style="{StaticResource PrimaryButtonStyle}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>